{% extends 'mytemplates/index.html' %}
{% load static %}
{% block content %}

<link rel="stylesheet" href="{% static 'css/cart.css' %}">

<div class="container mt-5">
  <h2 class="text-center mb-4">Your Cart</h2>

  {% if cart_items %}
  <form method="POST" action="{% url 'update_cart' %}" id="cartForm">
    {% csrf_token %}
    <div class="cart-items">
      {% for item in cart_items %}
      <div class="cart-item d-flex mb-3 align-items-center border p-3 rounded shadow-sm {% cycle 'bg-white' 'bg-light' %}">
        <img src="{{ item.product.image.url }}" alt="{{ item.product.product_name }}"
             style="height: 80px; width: auto; margin-right: 15px;">
        <div class="flex-grow-1">
          <h5>{{ item.product.product_name }}</h5>
          <p>Price: Rs. <span class="item-price">{{ item.product.price }}</span></p>

          <label>Quantity:
            <input type="number" name="quantity_{{ item.id }}" min="1" value="{{ item.quantity }}"
                   class="form-control form-control-sm w-50 quantity-input" data-price="{{ item.product.price }}" required>
          </label>

          <label class="ms-3">Size:
            <select name="size_{{ item.id }}" class="form-control form-control-sm w-50" required>
              <option value="">--Select--</option>
              <option value="S" {% if item.product.size == 'S' %}selected{% endif %}>S</option>
              <option value="M" {% if item.product.size == 'M' %}selected{% endif %}>M</option>
              <option value="L" {% if item.product.size == 'L' %}selected{% endif %}>L</option>
              <option value="XL" {% if item.product.size == 'XL' %}selected{% endif %}>XL</option>
            </select>
          </label>
        </div>

        <form action="{% url 'remove_cart_item' item.id %}" method="POST">
          {% csrf_token %}
          <button type="submit" class="btn btn-danger btn-sm">Remove</button>
        </form>
      </div>
      {% endfor %}
    </div>

    <div class="summary mt-4 text-end">
      <h4>Total: Rs. <span id="total-price">{{ total_price|floatformat:2 }}</span></h4>
      <button type="button" class="btn btn-primary" onclick="handleCartCheckout()">Proceed to Checkout</button>
    </div>
  </form>
  {% else %}
  <div class="alert alert-info mt-4">Your cart is empty.</div>
  {% endif %}
</div>

<!-- ‚úÖ Checkout Modal -->
<div class="modal fade" id="checkoutModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content p-4 rounded-4 shadow border-0">
      <div class="modal-header border-0">
        <h5 class="modal-title fw-bold">üõçÔ∏è Complete Your Order</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="POST" action="{% url 'checkout' %}" id="cartCheckoutForm">
        {% csrf_token %}
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label fw-semibold">Full Name</label>
            <input type="text" class="form-control" name="name" required>
          </div>
          <div class="mb-3">
            <label class="form-label fw-semibold">Phone Number</label>
            <input type="tel" class="form-control" name="phone" required>
          </div>
          <div class="mb-3">
            <label class="form-label fw-semibold">Shipping Address</label>
            <textarea name="address" class="form-control" required></textarea>
          </div>
          <div class="mb-3">
            <label class="form-label fw-semibold">Payment Method</label><br>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="payment_method" value="COD" checked>
              <label class="form-check-label">Cash on Delivery</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="payment_method" value="eSewa">
              <label class="form-check-label">eSewa</label>
            </div>
          </div>
        </div>
        <div class="modal-footer border-0">
          <button type="button" class="btn btn-success w-100 fw-bold" onclick="showCartConfirmModal()">üõí Place Order</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- ‚úÖ Confirmation Modal -->
<div class="modal fade" id="cartConfirmModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" style="max-width: 380px;">
    <div class="modal-content p-4 shadow rounded-4">
      <div class="modal-header border-0 pb-0">
        <h6 class="modal-title fw-bold">Confirm Order</h6>
      </div>
      <div class="modal-body text-center pt-1">
        <p class="fw-semibold mb-3">Are you sure you want to place this order?</p>
        <div class="d-flex justify-content-center gap-3">
          <button class="btn btn-outline-secondary px-4" data-bs-dismiss="modal">Cancel</button>
          <button class="btn btn-success px-4" onclick="finalizeCartOrder()">Yes, Place Order</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ‚úÖ JavaScript -->
<script>
  function updateTotal() {
    let total = 0;
    const quantityInputs = document.querySelectorAll(".quantity-input");

    quantityInputs.forEach(input => {
      const price = parseFloat(input.dataset.price);
      const quantity = parseInt(input.value);
      if (!isNaN(price) && !isNaN(quantity) && quantity > 0) {
        total += price * quantity;
      }
    });

    document.getElementById("total-price").innerText = total.toLocaleString("en-IN", {
      minimumFractionDigits: 2,
      maximumFractionDigits: 2
    });
  }

  function validateSizes() {
    const selects = document.querySelectorAll("select");
    for (let select of selects) {
      if (select.value === "") {
        alert("Please select a size for all products before proceeding to checkout.");
        return false;
      }
    }
    return true;
  }

  function handleCartCheckout() {
    if (validateSizes()) {
      const modal = new bootstrap.Modal(document.getElementById('checkoutModal'));
      modal.show();
    }
  }

  function showCartConfirmModal() {
    const confirmModal = new bootstrap.Modal(document.getElementById('cartConfirmModal'));
    confirmModal.show();
  }

  function finalizeCartOrder() {
    bootstrap.Modal.getInstance(document.getElementById('cartConfirmModal')).hide();
    bootstrap.Modal.getInstance(document.getElementById('checkoutModal')).hide();

    setTimeout(() => {
      document.getElementById("cartCheckoutForm").submit();
    }, 500);
  }

  document.querySelectorAll(".quantity-input").forEach(input => {
    input.addEventListener("input", updateTotal);
  });

  updateTotal();
</script>

{% endblock %}
